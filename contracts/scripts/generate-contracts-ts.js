#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

const DEPLOYMENTS_DIR = 'deployments';
const OUTPUT_FILE = '../frontend/src/config/deployments.ts';

// chain configurations
const CHAINS = {
  arcTestnet: {
    id: 5042002,
    name: 'Arc Testnet',
    rpcUrl: 'https://rpc.testnet.arc.network',
    usdc: '0x3600000000000000000000000000000000000000',
    blockExplorer: 'https://testnet.arcscan.app',
  },
  // future chains
  // polygonAmoy: { id: 80002, name: 'Polygon Amoy', ... },
  // arbitrumSepolia: { id: 421614, name: 'Arbitrum Sepolia', ... },
};

function loadDeployments() {
  const deployments = {};

  if (!fs.existsSync(DEPLOYMENTS_DIR)) {
    return deployments;
  }

  const files = fs.readdirSync(DEPLOYMENTS_DIR).filter(f => f.endsWith('.json'));

  for (const file of files) {
    const data = JSON.parse(fs.readFileSync(path.join(DEPLOYMENTS_DIR, file)));
    deployments[data.chainId] = data;
  }

  return deployments;
}

function generate() {
  const deployments = loadDeployments();

  const output = `// Auto-generated by scripts/generate-contracts-ts.js
// Do not edit manually - run 'make sync' to regenerate

import ArcPolicyManagerAbi from './abis/ArcPolicyManager.json';
// import PolicyManagerAbi from './abis/PolicyManager.json';

export { ArcPolicyManagerAbi };

// Chain configurations
export const CHAINS = ${JSON.stringify(CHAINS, null, 2)} as const;

// Deployment addresses by chain ID
export const DEPLOYMENTS: Record<number, Deployment> = ${JSON.stringify(deployments, null, 2)};

// Types
export interface Deployment {
  chainId: number;
  chainName: string;
  deployedAt: string;
  deployer: string;
  deployBlock?: number;
  contracts: {
    arcPolicyManager?: string;
    policyManager?: string;
  };
  addresses: {
    usdc: string;
    feeRecipient: string;
  };
}

// Helpers
export function getContractAddress(
  chainId: number,
  contract: 'arcPolicyManager' | 'policyManager'
): \`0x\${string}\` {
  const deployment = DEPLOYMENTS[chainId];
  if (!deployment) {
    throw new Error(\`No deployment found for chain \${chainId}\`);
  }
  const address = deployment.contracts[contract];
  if (!address) {
    throw new Error(\`Contract \${contract} not deployed on chain \${chainId}\`);
  }
  return address as \`0x\${string}\`;
}

export function getChainConfig(chainId: number) {
  const chain = Object.values(CHAINS).find(c => c.id === chainId);
  if (!chain) {
    throw new Error(\`Unknown chain \${chainId}\`);
  }
  return chain;
}
`;

  fs.mkdirSync(path.dirname(OUTPUT_FILE), { recursive: true });
  fs.writeFileSync(OUTPUT_FILE, output);
  console.log(`  âœ“ Generated ${OUTPUT_FILE}`);
}

generate();
