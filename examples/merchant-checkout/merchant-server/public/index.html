<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DemoApp - Pricing</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f8fafc;
      color: #1e293b;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    .header {
      text-align: center;
      margin-bottom: 3rem;
    }
    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .header p {
      color: #64748b;
      font-size: 1rem;
    }
    .plans {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 700px;
    }
    .plan {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      padding: 2rem;
      width: 300px;
      position: relative;
    }
    .plan.featured {
      border-color: #6366f1;
      box-shadow: 0 4px 24px rgba(99, 102, 241, 0.15);
    }
    .badge {
      position: absolute;
      top: -0.75rem;
      right: 1rem;
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
    }
    .plan-name {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .plan-desc {
      color: #64748b;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }
    .plan-price {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    .plan-price span {
      font-size: 0.875rem;
      font-weight: 400;
      color: #64748b;
    }
    .plan-interval {
      color: #64748b;
      font-size: 0.8rem;
      margin-bottom: 1.5rem;
    }
    .features {
      list-style: none;
      margin-bottom: 2rem;
    }
    .features li {
      padding: 0.4rem 0;
      font-size: 0.875rem;
      color: #475569;
    }
    .features li::before {
      content: "\2713 ";
      font-weight: 600;
    }
    .subscribe-btn {
      display: block;
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      transition: opacity 0.15s;
      color: white;
    }
    .subscribe-btn:hover { opacity: 0.9; }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }
    .loading .spinner {
      width: 2rem;
      height: 2rem;
      border: 3px solid #e2e8f0;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error {
      text-align: center;
      padding: 3rem;
      color: #ef4444;
    }
    .error p {
      margin-bottom: 0.5rem;
    }
    .error .hint {
      color: #64748b;
      font-size: 0.85rem;
    }

    .footer {
      margin-top: 3rem;
      color: #94a3b8;
      font-size: 0.75rem;
      text-align: center;
    }
    .footer code {
      background: #f1f5f9;
      padding: 0.15rem 0.4rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
    }
  </style>
</head>
<body>
  <div id="user-bar" style="display:none; position:fixed; top:0; left:0; right:0; background:white; border-bottom:1px solid #e2e8f0; padding:0.5rem 1.5rem; display:none; justify-content:space-between; align-items:center; z-index:100; font-size:0.8rem;">
    <span style="color:#64748b;" id="user-email"></span>
    <button onclick="handleLogout()" style="background:none; border:1px solid #e2e8f0; color:#64748b; font-size:0.75rem; cursor:pointer; padding:0.25rem 0.75rem; border-radius:0.25rem;">
      Sign out
    </button>
  </div>

  <div class="header" style="margin-top: 2.5rem;">
    <h1>DemoApp</h1>
    <p>Choose a plan to get started. Payments powered by AutoPay.</p>
    <div id="subscriber-banner" style="display:none; margin-top: 1rem; flex-direction:column; align-items:center; gap:0.5rem;">
      <a href="/content" style="display:inline-flex; align-items:center; gap:0.4rem; padding:0.5rem 1.25rem; background:#6366f1; color:white; border-radius:0.5rem; text-decoration:none; font-size:0.85rem; font-weight:600; transition:opacity 0.15s;">
        &#9654; Access Premium Content
      </a>
    </div>
  </div>

  <div class="plans" id="plans">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading plans from relayer...</p>
    </div>
  </div>

  <div class="footer">
    <p>This is a demo merchant server. Plans charge every 1 minute for easy testing.</p>
    <p style="margin-top: 0.5rem">
      Merchant address: <code id="merchant-address"></code>
    </p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/auth.js"></script>
  <script>
    // Auth gate — redirect to login if not authenticated
    (async () => {
      const session = await requireAuth()
      if (!session) return // redirect happening

      // Show user bar with email
      const userBar = document.getElementById('user-bar')
      const userEmail = document.getElementById('user-email')
      userEmail.textContent = session.user.email
      userBar.style.display = 'flex'

      // Check if user has active subscription via JWT
      const token = session.access_token
      try {
        const res = await fetch('/api/check-access', {
          headers: { 'Authorization': `Bearer ${token}` }
        })
        const data = await res.json()
        if (data.access) {
          document.getElementById('subscriber-banner').style.display = 'flex'
        }
      } catch {}
    })()

    function formatInterval(seconds) {
      if (seconds < 60) return `every ${seconds}s`
      if (seconds < 3600) {
        const mins = Math.floor(seconds / 60)
        return `every ${mins} min${mins > 1 ? 's' : ''}`
      }
      if (seconds < 86400) {
        const hours = Math.floor(seconds / 3600)
        return `every ${hours} hour${hours > 1 ? 's' : ''}`
      }
      const days = Math.floor(seconds / 86400)
      if (days === 30 || days === 31) return 'monthly'
      if (days === 365) return 'yearly'
      return `every ${days} day${days > 1 ? 's' : ''}`
    }

    async function loadPlans() {
      const container = document.getElementById('plans')
      const addressEl = document.getElementById('merchant-address')

      try {
        // Fetch config
        const configRes = await fetch('/api/config')
        const config = await configRes.json()
        addressEl.textContent = config.merchantAddress

        // Fetch plans from relayer via our proxy
        const plansRes = await fetch('/api/plans')
        if (!plansRes.ok) {
          const err = await plansRes.json().catch(() => ({}))
          throw new Error(err.details || `Server returned ${plansRes.status}`)
        }
        const plans = await plansRes.json()

        if (plans.length === 0) {
          container.innerHTML = `
            <div class="error">
              <p>No plans found</p>
              <p class="hint">
                Register plan metadata with the relayer using:<br>
                <code>npm run cli -- metadata:add --id pro-plan --merchant ${config.merchantAddress} --file plan.json</code>
              </p>
            </div>
          `
          return
        }

        container.innerHTML = ''

        for (const entry of plans) {
          const { id, metadata, metadataUrl } = entry
          const plan = metadata.plan || {}
          const billing = metadata.billing || {}
          const display = metadata.display || {}
          const merchant = metadata.merchant || {}

          const color = display.color || '#6366f1'
          const hasBadge = !!display.badge
          const amount = billing.amount ? `$${parseFloat(billing.amount).toFixed(2)}` : '—'
          const interval = billing.interval ? formatInterval(billing.interval) : ''
          const features = plan.features || []

          // Build checkout link — billing params go in the URL (on-chain source of truth)
          const serverUrl = window.location.origin
          const checkoutParams = new URLSearchParams({
            merchant: config.merchantAddress,
            metadata_url: metadataUrl,
            amount: billing.amount,
            interval: String(billing.interval),
            success_url: `${serverUrl}/success`,
            cancel_url: `${serverUrl}/cancel`,
          })
          if (billing.spending_cap) {
            checkoutParams.set('spending_cap', billing.spending_cap)
          }
          const checkoutLink = `${config.checkoutUrl}/?${checkoutParams.toString()}`

          const card = document.createElement('div')
          card.className = `plan${hasBadge ? ' featured' : ''}`
          if (hasBadge) {
            card.style.borderColor = color
            card.style.boxShadow = `0 4px 24px ${color}26`
          }

          card.innerHTML = `
            ${hasBadge ? `<div class="badge" style="background:${color}">${display.badge}</div>` : ''}
            <div class="plan-name">${plan.name || id}</div>
            <div class="plan-desc">${plan.description || ''}</div>
            <div class="plan-price">${amount} <span>${billing.currency || 'USDC'}</span></div>
            <div class="plan-interval">${interval}${billing.interval <= 300 ? ' (demo)' : ''}</div>
            <ul class="features">
              ${features.map(f => `<li style="--check-color:${color}">${f}</li>`).join('')}
            </ul>
            <a href="${checkoutLink}" class="subscribe-btn" style="background:${color}">
              Subscribe with AutoPay
            </a>
          `
          container.appendChild(card)
        }
      } catch (err) {
        container.innerHTML = `
          <div class="error">
            <p>Failed to load plans</p>
            <p class="hint">${err.message}</p>
            <p class="hint" style="margin-top: 1rem">
              Make sure the relayer is running and has plan metadata registered.
            </p>
          </div>
        `
      }
    }

    loadPlans()
  </script>
</body>
</html>
